# Pi 0.52.10 Extension Adoption Plan

> REQUIRED SUB-SKILL: Use @beads-code to implement this plan.

**Goal:** Bring existing extensions up to Pi 0.52.10 compatibility, fix the ContextUsage nullability break, and adopt high-value new extension capabilities where they materially improve reliability and debuggability.

**Architecture:** Implement in four feature tracks mapped to beads features under a single epic. Each track encodes TDD using explicit test-first tasks that block implementation tasks, followed by mandatory verification gates. Prioritize compatibility hardening first, then incremental adoption of model UX and lifecycle/input capabilities.

**Tech Stack:** TypeScript, Pi extension API (`@mariozechner/pi-coding-agent`), node:test/tsx, beads (`br`)

**Beads Epic:** `bd-2f4`

---

## Feature 1: ContextUsage null compatibility — `bd-3in`

### Task 1: Write tests for beads context usage null handling — `bd-ov0`

**Beads issue:** `bd-ov0`

**Files:**
- Update: `extensions/beads/lib.test.ts`
- Update: `extensions/beads/lib.ts` (if helper-level tests require API changes)

**Step 1: Write failing test**
- Add tests proving null percent does not trigger reminder logic and does not throw.

**Step 2: Verify RED**
- Run: `cd extensions/beads && npm test`
- Expect: new assertions fail before implementation.

**Step 3: Implement**
- No implementation in this task.

**Step 4: Verify GREEN**
- N/A (test-first task).

**Step 5: Commit**
- Commit RED test additions.

### Task 2: Implement beads reminder null guards for ContextUsage — `bd-1mn`

**Beads issue:** `bd-1mn`

**Files:**
- Update: `extensions/beads/index.ts`
- Update: `extensions/beads/lib.ts`

**Step 1: Implement null-safe guards**
- Guard `usage.percent` and `usage.tokens` before numeric operations.

**Step 2: Preserve existing behavior**
- Keep reminder behavior unchanged for non-null percentages.

**Step 3: Verify GREEN**
- Run: `cd extensions/beads && npm test`
- Expect: all tests pass.

**Step 4: Commit**
- Commit null-safe implementation.

### Task 3: Verify ContextUsage null-handling feature — `bd-2a0`

Subtasks:
- `bd-f5e` Run test suite for ContextUsage null-handling
- `bd-36v` Run linting and type checks for ContextUsage null-handling
- `bd-2s2` Clean commits check for ContextUsage null-handling

---

## Feature 2: Subagent model override UX alignment — `bd-3hk`

### Task 4: Write tests for subagent model override syntax passthrough — `bd-rw5`

**Beads issue:** `bd-rw5`

**Files:**
- Create/Update: `~/.pi/agent/extensions/subagent/*.test.ts` (or equivalent harness file)
- Update: `~/.pi/agent/extensions/subagent/index.ts`

**Step 1: Write failing test**
- Cover single/parallel/chain model passthrough for:
  - `provider/id`
  - fuzzy model names
  - `:<thinking>` suffix

**Step 2: Verify RED**
- Run subagent extension tests/harness command.

**Step 3: Implement**
- No implementation in this task.

**Step 4: Verify GREEN**
- N/A (test-first task).

**Step 5: Commit**
- Commit RED tests.

### Task 5: Implement subagent model override guidance and validation improvements — `bd-16p`

**Beads issue:** `bd-16p`

**Files:**
- Update: `~/.pi/agent/extensions/subagent/index.ts`
- Update: `~/.pi/agent/extensions/subagent/README.md` (create if missing)

**Step 1: Implement guidance/validation updates**
- Improve surfaced errors/documentation for new model patterns.

**Step 2: Preserve backward compatibility**
- Ensure plain legacy model IDs still work.

**Step 3: Verify GREEN**
- Run subagent tests/harness and smoke command(s).

**Step 4: Commit**
- Commit behavior/docs improvements.

### Task 6: Verify subagent model override feature — `bd-1e4`

Subtasks:
- `bd-146` Run test suite for subagent model override feature
- `bd-1uz` Run linting and type checks for subagent model override feature
- `bd-3t8` Clean commits check for subagent model override feature
- `bd-h4p` Manual smoke test for subagent model override forms

---

## Feature 3: Lifecycle observability hooks adoption — `bd-3s0`

### Task 7: Write tests for extension lifecycle observability hooks — `bd-3tf`

**Beads issue:** `bd-3tf`

**Files:**
- Update: `extensions/beads/lib.test.ts`
- Create/Update: `~/.pi/agent/extensions/subagent/*.test.ts` (if subagent selected for hooks)

**Step 1: Write failing test**
- Assert handlers are non-invasive and safe under normal workflows.

**Step 2: Verify RED**
- Run relevant extension tests/harness commands.

**Step 3: Implement**
- No implementation in this task.

**Step 4: Verify GREEN**
- N/A (test-first task).

**Step 5: Commit**
- Commit RED tests.

### Task 8: Implement opt-in lifecycle observability in extensions — `bd-1xv`

**Beads issue:** `bd-1xv`

**Files:**
- Update: `extensions/beads/index.ts`
- Update: `extensions/beads/README.md`
- Optional Update: `~/.pi/agent/extensions/subagent/index.ts`

**Step 1: Add opt-in event handlers**
- Use `message_*` and `tool_execution_*` hooks for actionable diagnostics.

**Step 2: Keep defaults quiet**
- Ensure no noisy notifications unless explicitly enabled.

**Step 3: Verify GREEN**
- Run tests and interactive smoke checks.

**Step 4: Commit**
- Commit observability changes.

### Task 9: Verify lifecycle observability feature — `bd-18r`

Subtasks:
- `bd-zrq` Run test suite for lifecycle observability feature
- `bd-cdn` Run linting and type checks for lifecycle observability feature
- `bd-38c` Clean commits check for lifecycle observability feature
- `bd-3lf` Manual smoke test for lifecycle observability

---

## Feature 4: Terminal input interception adoption — `bd-2tk`

### Task 10: Write tests for terminal input interception behavior — `bd-29t`

**Beads issue:** `bd-29t`

**Files:**
- Create/Update: selected extension test harness for interception behavior

**Step 1: Write failing test**
- Cover consume/transform behavior and listener lifecycle.

**Step 2: Verify RED**
- Run interception tests/harness.

**Step 3: Implement**
- No implementation in this task.

**Step 4: Verify GREEN**
- N/A (test-first task).

**Step 5: Commit**
- Commit RED tests.

### Task 11: Implement high-value terminal input interception use case — `bd-13j`

**Beads issue:** `bd-13j`

**Files:**
- Update: extension selected for interception (`confirm-rm` or other)
- Update: extension docs for behavior and fallback

**Step 1: Implement narrow interception use case**
- Keep behavior explicit, reversible, and safe.

**Step 2: Validate lifecycle cleanup**
- Ensure listeners are correctly registered/unregistered.

**Step 3: Verify GREEN**
- Run tests and interactive smoke checks.

**Step 4: Commit**
- Commit interception changes.

### Task 12: Verify terminal input interception feature — `bd-owe`

Subtasks:
- `bd-1cd` Run test suite for terminal input interception feature
- `bd-jtf` Run linting and type checks for terminal input interception feature
- `bd-2dr` Clean commits check for terminal input interception feature
- `bd-va4` Manual smoke test for terminal input interception

---

## Execution Order

1. `bd-ov0` → `bd-1mn` → `bd-2a0`
2. `bd-rw5` → `bd-16p` → `bd-1e4`
3. `bd-3tf` → `bd-1xv` → `bd-18r`
4. `bd-29t` → `bd-13j` → `bd-owe`

Feature tracks can run in parallel after Feature 1 starts, but each track must honor its TDD and verification blockers.
